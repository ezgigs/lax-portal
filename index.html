<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LAX Portal ‚Äî Videographer Job Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{--bg:#0f1117;--card:#171b24;--card2:#1e2330;--border:#252c3a;--border2:#2e3748;--text:#cdd6e8;--text2:#7e8fa8;--text3:#4a5568;--amber:#89b4fa;--amberd:rgba(137,180,250,.12);--red:#f38ba8;--redd:rgba(243,139,168,.15);--teal:#89dceb;--blue:#89b4fa;--blued:rgba(137,180,250,.12);--green:#a6e3a1;--greend:rgba(166,227,161,.12);--purple:#cba6f7;--gray:#45475a;--accent:#89b4fa;--accentd:rgba(137,180,250,.12);--r:10px;--rs:6px;--sh:0 4px 24px rgba(0,0,0,.5);--shl:0 8px 40px rgba(0,0,0,.7);--t:.22s cubic-bezier(.4,0,.2,1)}
html{font-size:14px}body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden}
h1,h2,h3,h4,h5{font-family:'Space Grotesk',sans-serif}button{cursor:pointer;font-family:'Inter',sans-serif;border:none;outline:none}input,select,textarea{font-family:'Inter',sans-serif;outline:none}
::-webkit-scrollbar{width:5px;height:5px}::-webkit-scrollbar-track{background:var(--card)}::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
@keyframes slideUp{from{opacity:0;transform:translateY(24px)}to{opacity:1;transform:translateY(0)}}
@keyframes slideInRight{from{opacity:0;transform:translateX(20px)}to{opacity:1;transform:translateX(0)}}
@keyframes fadeOverlay{from{opacity:0}to{opacity:1}}
#app-wrapper{display:flex;flex-direction:column;height:100vh;overflow:hidden}
#app-header{background:var(--card);border-bottom:1px solid var(--border);z-index:100;flex-shrink:0}
.filmstrip{height:8px;background:#0a0b0e;position:relative;overflow:hidden}
.filmstrip::after{content:'';position:absolute;inset:0;background:repeating-linear-gradient(90deg,transparent 0 5px,#0e0f13 5px 7px,transparent 7px 9px);background-size:14px 100%}
.fs-holes{position:absolute;top:0;left:0;right:0;height:8px;display:flex;align-items:center;padding:0 7px;gap:14px;z-index:1}
.fs-hole{width:4px;height:4px;border-radius:50%;background:#0e0f13;flex-shrink:0;box-shadow:0 0 0 1px rgba(255,255,255,.06)}
.hdr-inner{display:flex;align-items:center;justify-content:space-between;padding:12px 24px;gap:16px}
.hdr-brand{display:flex;align-items:center;gap:12px}
.hdr-icon{width:38px;height:38px;background:linear-gradient(135deg,var(--amber),#e8920f);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:18px;box-shadow:0 0 20px rgba(245,166,35,.3);flex-shrink:0}
.hdr-t{font-size:1.35rem;font-weight:800;letter-spacing:-.3px}.hdr-t span{color:var(--amber)}
.hdr-sub{font-size:.72rem;color:var(--text3);margin-top:1px}
.hdr-actions{display:flex;align-items:center;gap:8px}
.btn{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;border-radius:var(--rs);font-size:.83rem;font-weight:500;transition:all var(--t)}
.btn-p{background:var(--accent);color:#0f1117;font-weight:700;letter-spacing:.01em}.btn-p:hover{background:#a6c8ff;box-shadow:0 0 20px rgba(137,180,250,.3);transform:translateY(-1px)}
.btn-g{background:var(--card2);color:var(--text2);border:1px solid var(--border);letter-spacing:.01em}.btn-g:hover{background:var(--border);color:var(--text)}
.btn-d{background:var(--redd);color:var(--red);border:1px solid rgba(224,92,92,.3)}.btn-d:hover{background:rgba(224,92,92,.25)}
.btn-sm{padding:5px 12px;font-size:.78rem}
#stats-bar{background:var(--card);border-bottom:1px solid var(--border);padding:10px 24px;display:flex;gap:10px;overflow-x:auto;flex-shrink:0}
.stc{flex:1;min-width:130px;background:var(--card2);border:1px solid var(--border);border-radius:var(--r);padding:12px 16px;transition:all var(--t);position:relative;overflow:hidden}
.stc::before{content:'';position:absolute;top:0;left:0;right:0;height:2px}
.stc-j::before{background:var(--blue)}.stc-r::before{background:var(--amber)}.stc-p::before{background:var(--green)}.stc-d::before{background:var(--red)}
.stc:hover{border-color:var(--border2);transform:translateY(-2px);box-shadow:var(--sh)}
.stc-l{font-size:.68rem;color:var(--text3);text-transform:uppercase;letter-spacing:.8px;font-weight:600}
.stc-v{font-family:'Space Grotesk',sans-serif;font-size:1.55rem;font-weight:700;line-height:1;margin-top:3px}
.stc-s{font-size:.7rem;color:var(--text3);margin-top:3px}
#cov-alert{display:none;background:rgba(245,166,35,.07);border-bottom:1px solid rgba(245,166,35,.2);padding:7px 24px;font-size:.8rem;color:var(--amber);align-items:center;gap:8px;flex-shrink:0}
#cov-alert.show{display:flex}
#main-layout{display:flex;overflow:hidden;flex:1;min-height:0}
#roster{width:256px;min-width:256px;background:var(--card);border-right:1px solid var(--border);display:flex;flex-direction:column;transition:all .25s ease;overflow:hidden;flex-shrink:0}
#roster.collapsed{width:0;min-width:0;opacity:0;pointer-events:none}
.ros-h{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.ros-t{font-size:.78rem;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text2)}
.ros-body{flex:1;overflow-y:auto;padding:10px;display:flex;flex-direction:column;gap:7px}
.vgc{background:var(--card2);border:1px solid var(--border);border-radius:var(--r);padding:11px;cursor:pointer;transition:all var(--t)}
.vgc:hover{border-color:var(--border2);transform:translateY(-1px);box-shadow:var(--sh)}
.vgc.active{border-color:var(--accent);background:var(--accentd)}
.vgc.assign-mode{border-color:var(--green);background:rgba(166,227,161,.15);box-shadow:0 0 12px rgba(166,227,161,.3)}
.vgc .assign-badge{display:none;font-size:.6rem;background:var(--green);color:#0f1117;padding:1px 6px;border-radius:8px;font-weight:700;margin-left:auto}
.vgc.assign-mode .assign-badge{display:inline-block}
#assign-banner{display:none;background:linear-gradient(90deg,rgba(166,227,161,.15),rgba(137,180,250,.1));border:1px solid rgba(166,227,161,.3);border-radius:var(--rs);padding:8px 14px;margin:0 18px 8px;font-size:.78rem;color:var(--green);font-weight:600;align-items:center;gap:8px;animation:fadeIn .2s ease}
#assign-banner.show{display:flex}
#assign-banner button{background:rgba(243,139,168,.15);border:1px solid rgba(243,139,168,.3);color:var(--red);font-size:.7rem;padding:3px 10px;border-radius:var(--rs);margin-left:auto;cursor:pointer;transition:all var(--t)}
#assign-banner button:hover{background:rgba(243,139,168,.3)}
.dpill.assignable{animation:pulse-assign 1.2s ease infinite;cursor:pointer;outline:2px solid transparent;outline-offset:1px}
.dpill.assignable:hover{outline-color:var(--green);filter:brightness(1.4)!important}
@keyframes pulse-assign{0%,100%{opacity:1}50%{opacity:.6}}
.vgc-top{display:flex;align-items:center;gap:9px;margin-bottom:8px}
.vgc-dot{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.68rem;font-weight:700;color:#fff;flex-shrink:0}
.vgc-name{font-weight:600;font-size:.85rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.vgc-stats{display:grid;grid-template-columns:1fr 1fr;gap:3px}
.vgc-st{font-size:.7rem;color:var(--text3)}.vgc-st span{color:var(--text2);font-weight:600}
.vgc-bar{margin-top:7px;height:3px;background:var(--border);border-radius:2px;overflow:hidden}
.vgc-bar-f{height:100%;background:var(--green);border-radius:2px;transition:width .4s ease}
.ros-foot{padding:10px;border-top:1px solid var(--border);flex-shrink:0}
.btn-addvg{width:100%;background:var(--card2);border:1px dashed var(--border2);color:var(--text3);border-radius:var(--rs);padding:9px;font-size:.8rem;transition:all var(--t);display:flex;align-items:center;justify-content:center;gap:6px}
.btn-addvg:hover{border-color:var(--accent);color:var(--accent)}
#content{flex:1;display:flex;flex-direction:column;overflow:hidden;min-width:0}
#toolbar{padding:10px 18px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;flex-wrap:wrap;flex-shrink:0;background:var(--card)}
.vtabs{display:flex;background:var(--card2);border:1px solid var(--border);border-radius:var(--rs);padding:3px;gap:2px}
.vtab{padding:5px 14px;border-radius:4px;font-size:.8rem;font-weight:600;color:var(--text3);background:transparent;transition:all var(--t)}
.vtab.active{background:var(--accent);color:#0f1117}
.vtab:hover:not(.active){color:var(--text);background:var(--border)}
.navc{display:flex;align-items:center;gap:6px;margin-left:auto}
.nav-b{width:28px;height:28px;background:var(--card2);border:1px solid var(--border);border-radius:var(--rs);color:var(--text2);display:flex;align-items:center;justify-content:center;font-size:.9rem;transition:all var(--t)}
.nav-b:hover{border-color:var(--border2);color:var(--text)}
.nav-l{font-family:'Space Grotesk',sans-serif;font-size:.88rem;font-weight:700;min-width:150px;text-align:center}
.ros-tog{width:28px;height:28px;background:var(--card2);border:1px solid var(--border);border-radius:var(--rs);color:var(--text2);display:flex;align-items:center;justify-content:center;font-size:.85rem;transition:all var(--t)}
.ros-tog:hover{border-color:var(--accent);color:var(--accent)}
#fbar{padding:7px 18px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:7px;flex-wrap:wrap;background:var(--bg);flex-shrink:0}
.fsel{background:var(--card);border:1px solid var(--border);color:var(--text2);border-radius:var(--rs);padding:4px 24px 4px 9px;font-size:.76rem;appearance:none;-webkit-appearance:none;cursor:pointer;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%239499b0' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 7px center;transition:all var(--t)}
.fsel:focus{border-color:var(--accent);color:var(--text)}
.fchip{display:inline-flex;align-items:center;gap:4px;padding:3px 9px;border-radius:20px;font-size:.73rem;font-weight:500;cursor:pointer;border:1px solid var(--border);background:var(--card);color:var(--text2);transition:all var(--t)}
.fchip.active{background:var(--accentd);border-color:var(--accent);color:var(--accent)}
.fchip:hover:not(.active){border-color:var(--border2);color:var(--text)}
.af-chip{display:inline-flex;align-items:center;gap:5px;padding:3px 9px;border-radius:20px;font-size:.72rem;font-weight:500;background:var(--blued);border:1px solid rgba(91,141,238,.3);color:var(--blue)}
.af-chip button{background:none;border:none;color:inherit;font-size:.85rem;line-height:1;padding:0;cursor:pointer}
.btn-clr{background:transparent;border:none;color:var(--text3);font-size:.73rem;padding:3px 7px;border-radius:var(--rs);transition:all var(--t)}
.btn-clr:hover{color:var(--red)}
#cal{flex:1;overflow:auto;padding:14px 18px}
.mgrid{display:grid;grid-template-columns:repeat(7,1fr);gap:1px;background:var(--border);border-radius:var(--r);overflow:hidden}
.mhdr{background:var(--card2);padding:7px;text-align:center;font-size:.68rem;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--text3)}
.mday{background:var(--card);padding:6px;min-height:90px;cursor:pointer;transition:background var(--t);display:flex;flex-direction:column;gap:2px}
.mday:hover{background:var(--card2)}.mday.om{opacity:.3}.mday.today{background:rgba(137,180,250,.05)}.mday.today .dnum{color:var(--accent);font-weight:700}
.dnum{font-size:.78rem;font-weight:600;color:var(--text2);line-height:1;margin-bottom:2px}
.dpill{display:block;padding:2px 5px;border-radius:3px;font-size:.64rem;font-weight:600;cursor:pointer;transition:all var(--t);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:#fff}
.dpill:hover{filter:brightness(1.2)}.dmore{font-size:.62rem;color:var(--text3);cursor:pointer}.dmore:hover{color:var(--amber)}
.ww{display:flex;border:1px solid var(--border);border-radius:var(--r);overflow:hidden;background:var(--border)}
.wtc{width:52px;min-width:52px;background:var(--card2);flex-shrink:0}
.wth{height:46px;border-bottom:1px solid var(--border)}
.wts{height:48px;display:flex;align-items:flex-start;justify-content:flex-end;padding:3px 7px 0 0;font-size:.62rem;color:var(--text3);border-bottom:1px solid var(--border)}
.wdc{flex:1;background:var(--card);min-width:0;position:relative}
.wdh{height:46px;border-bottom:1px solid var(--border);display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;transition:background var(--t)}
.wdh:hover{background:var(--card2)}.wdh.today{background:rgba(137,180,250,.07)}
.wdn{font-size:.65rem;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;font-weight:600}
.wdd{font-family:'Space Grotesk',sans-serif;font-size:.95rem;font-weight:700}.wdh.today .wdd{color:var(--accent)}
.wsa{position:relative}.wsbg{height:48px;border-bottom:1px solid var(--border)}
.wev{position:absolute;left:2px;right:2px;border-radius:4px;padding:3px 5px;font-size:.64rem;font-weight:600;cursor:pointer;transition:all var(--t);overflow:hidden;z-index:2;border-left:3px solid rgba(255,255,255,.25);color:#fff}
.wev:hover{filter:brightness(1.15);z-index:3;box-shadow:var(--sh)}
.wet{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.weti{opacity:.7;font-size:.6rem}
.lg{margin-bottom:18px;animation:fadeIn .3s ease forwards}
.ldh{display:flex;align-items:center;gap:10px;margin-bottom:8px}
.ldl{font-family:'Space Grotesk',sans-serif;font-size:.8rem;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:.8px;white-space:nowrap}
.ldline{flex:1;height:1px;background:var(--border)}.tbd{font-size:.63rem;background:var(--accent);color:#0f1117;padding:2px 7px;border-radius:10px;font-weight:700}
.jc{background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:13px 15px;margin-bottom:7px;cursor:pointer;transition:all var(--t);display:grid;grid-template-columns:4px 1fr auto;gap:12px;align-items:start;animation:fadeIn .25s ease forwards}
.jc:hover{border-color:var(--border2);transform:translateY(-1px);box-shadow:var(--sh)}
.jcb{border-radius:2px;align-self:stretch}
.jcm{display:flex;flex-direction:column;gap:5px;min-width:0}
.jct{font-family:'Space Grotesk',sans-serif;font-size:.92rem;font-weight:700;display:flex;align-items:center;gap:7px;flex-wrap:wrap}
.cfb{font-size:.63rem;background:rgba(245,166,35,.15);color:var(--amber);border:1px solid rgba(245,166,35,.3);padding:1px 6px;border-radius:4px}
.jcmeta{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.jcmi{font-size:.73rem;color:var(--text3);display:flex;align-items:center;gap:3px}
.jcr{display:flex;flex-direction:column;align-items:flex-end;gap:5px;flex-shrink:0}
.sbadge{display:inline-flex;align-items:center;gap:4px;padding:3px 9px;border-radius:20px;font-size:.7rem;font-weight:600;white-space:nowrap}
.payamt{font-family:'Space Grotesk',sans-serif;font-size:.88rem;font-weight:700;color:var(--green)}
.ptl{display:flex;align-items:center;gap:4px;margin-top:4px}
.pts{display:flex;align-items:center;gap:3px;font-size:.64rem;color:var(--text3)}.pts.dn{color:var(--green)}.pts.ac{color:var(--amber)}
.pta{color:var(--border2);font-size:.6rem}
.empty{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:60px 20px;gap:12px;color:var(--text3);text-align:center}
.empty-i{font-size:3rem;opacity:.3}.empty-t{font-size:.88rem}
#mo{position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:1000;display:none;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(6px);transition:opacity var(--t)}
#mo.open{display:flex;animation:fadeOverlay .2s ease}
#mdl{background:var(--card);border:1px solid var(--border2);border-radius:16px;width:100%;max-width:560px;max-height:90vh;overflow-y:auto;animation:slideUp .28s cubic-bezier(.4,0,.2,1);box-shadow:var(--shl)}
.mh{padding:18px 24px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;background:var(--card);z-index:1;border-radius:14px 14px 0 0}
.mt{font-size:1.05rem;font-weight:700}
.mx{width:30px;height:30px;background:var(--card2);border:1px solid var(--border);border-radius:var(--rs);color:var(--text2);display:flex;align-items:center;justify-content:center;font-size:1.1rem;transition:all var(--t)}
.mx:hover{background:rgba(243,139,168,.15);border-color:var(--red);color:var(--red)}
.mb{padding:18px 24px}
.fg{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.fgr{display:flex;flex-direction:column;gap:5px}.fgr.full{grid-column:1/-1}
.fl{font-size:.74rem;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:.5px}
.fi,.fse,.fta{background:var(--card2);border:1px solid var(--border);color:var(--text);border-radius:var(--rs);padding:9px 12px;font-size:.85rem;transition:all var(--t);width:100%}
.fi:focus,.fse:focus,.fta:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(137,180,250,.12)}
.fse{appearance:none;-webkit-appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%239499b0' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 10px center;padding-right:28px;background-color:var(--card2)}
.fta{resize:vertical;min-height:70px}
.vg-multi{position:relative}
.vg-multi-display{background:var(--card2);border:1px solid var(--border);color:var(--text);border-radius:var(--rs);padding:9px 28px 9px 12px;font-size:.85rem;cursor:pointer;transition:all var(--t);min-height:38px;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%239499b0' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 10px center}
.vg-multi-display:hover{border-color:var(--border2)}
.vg-multi-dd{display:none;position:absolute;top:100%;left:0;right:0;background:var(--card);border:1px solid var(--border2);border-radius:var(--rs);margin-top:4px;max-height:180px;overflow-y:auto;z-index:20;box-shadow:var(--sh);padding:4px 0}
.vg-multi-dd.open{display:block}
.vg-multi-dd label{display:flex;align-items:center;gap:8px;padding:7px 12px;font-size:.82rem;cursor:pointer;transition:background var(--t)}
.vg-multi-dd label:hover{background:var(--card2)}
.vg-multi-dd input[type=checkbox]{accent-color:var(--green);width:15px;height:15px;cursor:pointer}
.ferr{font-size:.72rem;color:var(--red);margin-top:2px;display:none}.ferr.show{display:block}
.mf{padding:14px 24px;border-top:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:10px;position:sticky;bottom:0;background:var(--card);border-radius:0 0 14px 14px}
.mf-r{display:flex;gap:8px}
#vmo{position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:1001;display:none;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(6px)}
#vmo.open{display:flex;animation:fadeOverlay .2s ease}
#vmdl{background:var(--card);border:1px solid var(--border2);border-radius:16px;width:100%;max-width:380px;animation:slideUp .28s cubic-bezier(.4,0,.2,1);box-shadow:var(--shl);padding:24px}
#vmdl h3{font-size:1rem;font-weight:700;margin-bottom:18px}
#dp{position:fixed;right:0;top:0;bottom:0;width:300px;background:var(--card);border-left:1px solid var(--border);z-index:200;transform:translateX(100%);transition:transform .3s cubic-bezier(.4,0,.2,1);display:flex;flex-direction:column;box-shadow:var(--shl)}
#dp.open{transform:translateX(0)}
.dph{padding:16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.dpt{font-size:.95rem;font-weight:700}
.dpb{flex:1;overflow-y:auto;padding:12px}
.dpj{background:var(--card2);border:1px solid var(--border);border-radius:var(--r);padding:11px;margin-bottom:8px;cursor:pointer;transition:all var(--t);border-left:3px solid transparent}
.dpj:hover{border-color:var(--border2);transform:translateX(2px)}
.dpjt{font-weight:600;font-size:.85rem;margin-bottom:4px}.dpjm{font-size:.72rem;color:var(--text3)}
@media(max-width:768px){#roster{display:none}.fg{grid-template-columns:1fr}.fgr.full{grid-column:1}#stats-bar{gap:7px}.stc-v{font-size:1.2rem}.hdr-t{font-size:1.1rem}.nav-l{min-width:100px;font-size:.78rem}}
#pmo{position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:1002;display:none;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(6px)}
#pmo.open{display:flex;animation:fadeOverlay .2s ease}
#pmdl{background:var(--card);border:1px solid var(--border2);border-radius:16px;width:100%;max-width:700px;max-height:90vh;overflow-y:auto;animation:slideUp .28s cubic-bezier(.4,0,.2,1);box-shadow:var(--shl)}
#pmdl .mh{border-radius:14px 14px 0 0}
.paste-area{background:var(--card2);border:1px solid var(--border);border-radius:var(--rs);padding:12px;font-size:.82rem;color:var(--text);width:100%;min-height:140px;resize:vertical;line-height:1.6;transition:all var(--t)}
.paste-area:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(137,180,250,.12)}
.paste-area::placeholder{color:var(--text3)}
.parse-btn{margin-top:10px;width:100%}
#parse-preview{margin-top:16px;display:none}
.preview-table{width:100%;border-collapse:collapse;font-size:.78rem}
.preview-table th{background:var(--card2);color:var(--text3);font-size:.68rem;text-transform:uppercase;letter-spacing:.6px;padding:7px 10px;text-align:left;border-bottom:1px solid var(--border)}
.preview-table td{padding:7px 10px;border-bottom:1px solid var(--border);color:var(--text);vertical-align:middle}
.preview-table tr:hover td{background:var(--card2)}
.preview-table input.pi{background:transparent;border:none;color:var(--text);font-size:.78rem;width:100%;padding:2px 4px;border-radius:3px}
.preview-table input.pi:focus{background:var(--card2);outline:1px solid var(--accent)}
.preview-table select.ps{background:transparent;border:none;color:var(--text2);font-size:.72rem;cursor:pointer;appearance:none;-webkit-appearance:none;padding:2px 4px}
.preview-table select.ps:focus{background:var(--card2);outline:1px solid var(--accent);border-radius:3px}
.row-del{background:none;border:none;color:var(--text3);cursor:pointer;font-size:.9rem;padding:2px 5px;border-radius:3px;transition:all var(--t)}
.row-del:hover{color:var(--red);background:var(--redd)}
.parse-hint{font-size:.75rem;color:var(--text3);margin-top:8px;line-height:1.5}
.parse-hint span{color:var(--amber)}
.preview-count{font-size:.8rem;color:var(--text2);margin-bottom:10px;display:flex;align-items:center;gap:8px}
.preview-count strong{color:var(--accent);font-family:'Space Grotesk',sans-serif}
.avail-chips{display:flex;gap:4px;flex-wrap:nowrap}
.avail-chip{padding:3px 9px;border-radius:20px;font-size:.68rem;font-weight:700;cursor:pointer;border:1px solid transparent;transition:all .15s ease;white-space:nowrap;background:var(--card2);color:var(--text3);border-color:var(--border)}
.avail-chip.sel-yes{background:rgba(92,184,92,.2);color:#5cb85c;border-color:#5cb85c}
.avail-chip.sel-no{background:rgba(224,92,92,.2);color:#e05c5c;border-color:#e05c5c}
.avail-chip.sel-maybe{background:rgba(245,166,35,.15);color:#f5a623;border-color:#f5a623}
.avail-chip.sel-pending{background:rgba(91,141,238,.15);color:#5b8dee;border-color:#5b8dee}
.p-time-override{display:flex;align-items:center;gap:6px;margin-top:8px;padding:7px 10px;background:var(--card2);border:1px solid var(--border);border-radius:var(--rs);font-size:.75rem;color:var(--text3)}
.p-time-override button{font-size:.72rem;padding:3px 10px}
.mass-row{display:flex;align-items:center;gap:8px;flex-wrap:wrap;padding:10px 12px;background:var(--card2);border:1px solid var(--border);border-radius:var(--rs);margin-bottom:8px}
.mass-row-label{font-size:.68rem;font-weight:700;text-transform:uppercase;letter-spacing:.7px;color:var(--text3);white-space:nowrap;min-width:80px}
.mass-chip{padding:4px 11px;border-radius:20px;font-size:.72rem;font-weight:700;cursor:pointer;border:1px solid var(--border);background:var(--card);color:var(--text3);transition:all .15s ease;white-space:nowrap}
.mass-chip:hover{border-color:var(--border2);color:var(--text)}
.mass-chip.mc-confirmed{background:rgba(92,184,92,.2);color:#5cb85c;border-color:#5cb85c}
.mass-chip.mc-needs{background:rgba(245,166,35,.15);color:#f5a623;border-color:#f5a623}
.mass-chip.mc-cancelled{background:rgba(224,92,92,.2);color:#e05c5c;border-color:#e05c5c}
.mass-chip.mc-pending{background:rgba(91,141,238,.15);color:#5b8dee;border-color:#5b8dee}
.mass-chip.mc-inprog{background:rgba(78,205,196,.15);color:#4ecdc4;border-color:#4ecdc4}
.color-dot{width:20px;height:20px;border-radius:50%;cursor:pointer;border:2px solid transparent;transition:all .15s ease;flex-shrink:0}
.color-dot:hover{transform:scale(1.2)}
.color-dot.sel{border-color:#fff;transform:scale(1.15)}
#mass-controls{display:none;margin-top:12px}
#notif-panel{position:fixed;right:0;top:0;bottom:0;width:320px;background:var(--card);border-left:1px solid var(--border);z-index:300;transform:translateX(100%);transition:transform .3s cubic-bezier(.4,0,.2,1);display:flex;flex-direction:column;box-shadow:var(--shl)}
#notif-panel.open{transform:translateX(0)}
.notif-h{padding:16px 18px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.notif-title{font-family:'Space Grotesk',sans-serif;font-size:.95rem;font-weight:700;display:flex;align-items:center;gap:8px}
.notif-badge{background:var(--accent);color:#0f1117;font-size:.62rem;font-weight:700;padding:1px 6px;border-radius:10px;min-width:18px;text-align:center}
.notif-body{flex:1;overflow-y:auto;padding:10px}
.notif-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;gap:10px;color:var(--text3);font-size:.82rem;text-align:center}
.notif-item{background:var(--card2);border:1px solid var(--border);border-radius:var(--r);padding:12px 14px;margin-bottom:8px;animation:slideInRight .25s ease;border-left:3px solid var(--accent)}
.notif-item.unread{border-left-color:var(--accent);background:rgba(137,180,250,.05)}
.notif-item.read{border-left-color:var(--border);opacity:.7}
.notif-job{font-family:'Space Grotesk',sans-serif;font-size:.82rem;font-weight:600;color:var(--text);margin-bottom:3px}
.notif-note{font-size:.78rem;color:var(--text2);line-height:1.5;margin-bottom:5px}
.notif-meta{font-size:.68rem;color:var(--text3);display:flex;align-items:center;justify-content:space-between}
.notif-foot{padding:10px 14px;border-top:1px solid var(--border);flex-shrink:0}
#notif-btn{position:relative}
.notif-dot{position:absolute;top:-2px;right:-2px;width:8px;height:8px;background:var(--accent);border-radius:50%;border:2px solid var(--card);display:none}
#notif-btn.has-unread .notif-dot{display:block}
</style>
</head>
<body>
<div id="app-wrapper">
  <header id="app-header">
    <div class="filmstrip"><div class="fs-holes" id="fsh"></div></div>
    <div class="hdr-inner">
      <div class="hdr-brand"></div>
      <div class="hdr-actions">
        <button class="btn btn-g btn-sm" id="btn-exp" title="Export CSV">‚¨á Export</button>
        <button class="btn btn-g btn-sm" id="btn-undo" title="Undo last import" style="display:none;color:var(--amber);border-color:rgba(137,180,250,.3)">‚Ü© Undo Import</button>
        <button class="btn btn-g btn-sm" id="btn-paste" title="Paste Schedule">üìã Paste Schedule</button>
        <button class="btn btn-g btn-sm" id="notif-btn" title="Notes &amp; Notifications">üîî Notes <div class="notif-dot"></div></button>
        <button class="btn btn-p" id="btn-new" title="New Job (N)">Ôºã New Job</button>
      </div>
    </div>
  </header>
  <div id="stats-bar">
    <div class="stc stc-j"><div class="stc-l">Jobs This Month</div><div class="stc-v" id="sv-j">0</div><div class="stc-s" id="ss-j"></div></div>
    <div class="stc stc-r"><div class="stc-l">Total Revenue</div><div class="stc-v" id="sv-r">$0</div><div class="stc-s" id="ss-r">this month</div></div>
    <div class="stc stc-p"><div class="stc-l">Amount Paid</div><div class="stc-v" id="sv-p">$0</div><div class="stc-s" id="ss-p">collected</div></div>
    <div class="stc stc-d"><div class="stc-l">Pending</div><div class="stc-v" id="sv-d">$0</div><div class="stc-s" id="ss-d">outstanding</div></div>
  </div>
  <div id="cov-alert"><span>‚ö†</span><span id="cov-text"></span></div>
  <div id="main-layout">
    <aside id="roster">
      <div class="ros-h"><span class="ros-t">üìπ Roster</span></div>
      <div class="ros-body" id="ros-body"></div>
      <div class="ros-foot"><button class="btn-addvg" id="btn-addvg">Ôºã Add Videographer</button></div>
    </aside>
    <main id="content">
      <div id="toolbar">
        <button class="ros-tog" id="ros-tog" title="Toggle Roster">‚ò∞</button>
        <div class="vtabs">
          <button class="vtab active" data-view="month">Month</button>
          <button class="vtab" data-view="week">Week</button>
          <button class="vtab" data-view="list">List</button>
        </div>
        <div class="navc">
          <button class="nav-b" id="nav-prev">‚Äπ</button>
          <span class="nav-l" id="nav-label"></span>
          <button class="nav-b" id="nav-next">‚Ä∫</button>
          <button class="nav-b" id="nav-today" title="Today" style="font-size:.7rem;width:auto;padding:0 8px">Today</button>
        </div>
      </div>
      <div id="fbar">
        <span style="font-size:.72rem;color:var(--text3);font-weight:600">Filters:</span>
        <select class="fsel" id="f-status"><option value="">All Statuses</option><option value="Needs Coverage">Needs Coverage</option><option value="Confirmed">Confirmed</option><option value="In Progress">In Progress</option><option value="Delivered">Delivered</option><option value="Paid">Paid</option><option value="Pending Payment">Pending Payment</option><option value="Cancelled">Cancelled</option></select>
        <select class="fsel" id="f-vg"><option value="">All Videographers</option></select>
        <select class="fsel" id="f-team"><option value="">All Teams</option></select>
        <select class="fsel" id="f-type"><option value="">All Types</option><option value="Game Coverage">Game Coverage</option><option value="Event">Event</option><option value="Tournament">Tournament</option><option value="Highlight Reel">Highlight Reel</option><option value="Other">Other</option></select>
        <div id="af-chips"></div>
        <button class="btn-clr" id="btn-clr" style="display:none">‚úï Clear All</button>
      </div>
      <div id="assign-banner"><span id="assign-text">üéØ Assign mode</span><button id="assign-exit">‚úï Exit</button></div>
      <div id="cal"></div>
    </main>
  </div>
</div>
<!-- Job Modal -->
<div id="mo">
  <div id="mdl">
    <div class="mh"><h3 class="mt" id="mdl-title">New Job</h3><button class="mx" id="mdl-close">‚úï</button></div>
    <div class="mb">
      <div class="fg">
        <div class="fgr full"><label class="fl">Title *</label><input class="fi" id="m-title" placeholder="e.g. Boys Varsity vs. Westfield"><div class="ferr" id="e-title">Title is required</div></div>
        <div class="fgr"><label class="fl">Date *</label><input class="fi" type="date" id="m-date"><div class="ferr" id="e-date">Date is required</div></div>
        <div class="fgr"><label class="fl">Type</label><select class="fse" id="m-type"><option>Game Coverage</option><option>Event</option><option>Tournament</option><option>Highlight Reel</option><option>Other</option></select></div>
        <div class="fgr"><label class="fl">Start Time</label><input class="fi" type="time" id="m-start" value="09:00"></div>
        <div class="fgr"><label class="fl">End Time</label><input class="fi" type="time" id="m-end" value="11:00"></div>
        <div class="fgr"><label class="fl">Team</label><input class="fi" id="m-team" placeholder="e.g. Boys Varsity"></div>
        <div class="fgr"><label class="fl">Videographer(s)</label><div class="vg-multi" id="m-vg-wrap"><div class="vg-multi-display" id="m-vg-display">Unassigned</div><div class="vg-multi-dd" id="m-vg-dd"></div></div></div>
        <div class="fgr"><label class="fl">Status</label><select class="fse" id="m-status"><option>Needs Coverage</option><option>Confirmed</option><option>In Progress</option><option>Delivered</option><option>Paid</option><option>Pending Payment</option><option>Cancelled</option></select></div>
        <div class="fgr"><label class="fl">Pay Amount ($)</label><input class="fi" type="number" id="m-pay" placeholder="0" min="0"></div>
        <div class="fgr full"><label class="fl">Notes</label><textarea class="fta" id="m-notes" placeholder="Additional details..."></textarea></div>
      </div>
    </div>
    <div class="mf">
      <button class="btn btn-d" id="mdl-del" style="display:none">üóë Delete</button>
      <div class="mf-r">
        <button class="btn btn-g" id="mdl-cancel">Cancel</button>
        <button class="btn btn-p" id="mdl-save">Save Job</button>
      </div>
    </div>
  </div>
</div>
<!-- VG Modal -->
<div id="vmo">
  <div id="vmdl">
    <h3>Add Videographer</h3>
    <div style="display:flex;flex-direction:column;gap:14px">
      <div class="fgr"><label class="fl">Name *</label><input class="fi" id="vm-name" placeholder="Full name"><div class="ferr" id="ve-name">Name is required</div></div>
      <div class="fgr"><label class="fl">Color</label>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:4px" id="vm-colors"></div>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
        <button class="btn btn-g" id="vm-cancel">Cancel</button>
        <button class="btn btn-p" id="vm-save">Add</button>
      </div>
    </div>
  </div>
</div>
<!-- Paste Schedule Modal -->
<div id="pmo">
  <div id="pmdl">
    <div class="mh"><h3 class="mt">üìã Paste Schedule</h3><button class="mx" id="pmo-close">‚úï</button></div>
    <div class="mb">
      <div class="parse-hint">Paste any schedule text ‚Äî one game per line. Supports formats like:<br>
        <span>Tuesday, 2/24 - 4pm - vs Gonzaga</span> &nbsp;¬∑&nbsp; <span>Friday 4/24 - 4:30pm vs SSSA</span> &nbsp;¬∑&nbsp; <span>3/15 at 6pm at Good Counsel</span>
      </div>
      <div class="fgr" style="margin-top:12px">
        <label class="fl">Team (applied to all imported jobs)</label>
        <input class="fi" id="p-team" placeholder="e.g. Boys Varsity (optional)">
      </div>
      <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:10px">
        <div class="fgr" style="flex:0 0 auto">
          <label class="fl">Year (if not in text)</label>
          <input class="fi" id="p-year" placeholder="e.g. 2025" style="max-width:110px">
        </div>
        <div class="fgr" style="flex:0 0 auto">
          <label class="fl">Override Start Time (all rows)</label>
          <input class="fi" type="time" id="p-start" style="max-width:130px">
        </div>
        <div class="fgr" style="flex:0 0 auto">
          <label class="fl">Override End Time (all rows)</label>
          <input class="fi" type="time" id="p-end" style="max-width:130px">
        </div>
      </div>
      <textarea class="paste-area" id="paste-input" placeholder="Paste schedule here...&#10;&#10;Tuesday, 2/24 - 4pm - vs Gonzaga&#10;Friday, 2/27 - 4:45pm - vs Washington &amp; Liberty&#10;Saturday, 2/28 - 11am at St Christopher's" style="margin-top:12px"></textarea>
      <button class="btn btn-p parse-btn" id="btn-parse">üîç Parse Schedule</button>
      <div id="parse-preview">
        <div id="mass-controls">
          <div class="mass-row">
            <span class="mass-row-label">Set All Status:</span>
            <button class="mass-chip" data-mass-status="Confirmed">‚úì Confirmed</button>
            <button class="mass-chip" data-mass-status="Needs Coverage">‚ö† Needs Coverage</button>
            <button class="mass-chip" data-mass-status="In Progress">‚ñ∂ In Progress</button>
            <button class="mass-chip" data-mass-status="Pending Payment">üí∞ Pending Payment</button>
            <button class="mass-chip" data-mass-status="Cancelled">‚úï Cancelled</button>
          </div>
          <div class="mass-row">
            <span class="mass-row-label">Assign All VG:</span>
            <select class="fsel" id="mass-vg" style="min-width:140px"><option value="Unassigned">Unassigned</option></select>
          </div>
          <div class="mass-row">
            <span class="mass-row-label">Set All Color:</span>
            <div id="mass-color-dots" style="display:flex;gap:7px;align-items:center;flex-wrap:wrap"></div>
            <button class="mass-chip" id="mass-color-clear" style="margin-left:4px">‚úï Clear</button>
          </div>
        </div>
        <div class="preview-count"><strong id="parse-count">0</strong> games detected ‚Äî review &amp; edit before importing:</div>
        <div style="overflow-x:auto">
          <table class="preview-table">
            <thead><tr><th>Title / Opponent</th><th>Date</th><th>Start</th><th>End</th><th>Status</th><th>Videographer</th><th>Color</th><th>Avail.</th><th></th></tr></thead>
            <tbody id="parse-tbody"></tbody>
          </table>
        </div>
      </div>
    </div>
    <div class="mf">
      <span style="font-size:.75rem;color:var(--text3)" id="import-status"></span>
      <div class="mf-r">
        <button class="btn btn-g" id="pmo-cancel">Cancel</button>
        <button class="btn btn-p" id="btn-import" style="display:none">‚¨á Import All Jobs</button>
      </div>
    </div>
  </div>
</div>
<!-- Notifications Panel -->
<div id="notif-panel">
  <div class="notif-h">
    <div class="notif-title">üîî Notes &amp; Activity <span class="notif-badge" id="notif-count" style="display:none">0</span></div>
    <button class="mx" id="notif-close">‚úï</button>
  </div>
  <div class="notif-body" id="notif-body"></div>
  <div class="notif-foot">
    <button class="btn btn-g" style="width:100%;font-size:.75rem" id="notif-clear">‚úï Clear All</button>
  </div>
</div>
<!-- Day Panel -->
<div id="dp">
  <div class="dph"><h4 class="dpt" id="dp-title">Day</h4><button class="mx" id="dp-close">‚úï</button></div>
  <div class="dpb" id="dp-body"></div>
</div>
<script>
/* ===== STATE ===== */
const STATUSES = ['Needs Coverage','Confirmed','In Progress','Delivered','Paid','Pending Payment','Cancelled'];
const TYPES = ['Game Coverage','Event','Tournament','Highlight Reel','Other'];
const STATUS_COLORS = {'Needs Coverage':'#f5a623','Confirmed':'#5cb85c','In Progress':'#5b8dee','Delivered':'#5b8dee','Paid':'#5cb85c','Pending Payment':'#e05c5c','Cancelled':'#555870'};
const STATUS_DIM = {'Needs Coverage':'rgba(245,166,35,.15)','Confirmed':'rgba(92,184,92,.15)','In Progress':'rgba(91,141,238,.15)','Delivered':'rgba(91,141,238,.15)','Paid':'rgba(92,184,92,.15)','Pending Payment':'rgba(224,92,92,.15)','Cancelled':'rgba(85,88,112,.2)'};
const VG_COLORS = ['#5b8dee','#e05c5c','#5cb85c','#f5a623','#9b59b6','#4ecdc4','#e67e22','#1abc9c','#e74c3c','#3498db'];

function uid(){return Date.now().toString(36)+Math.random().toString(36).slice(2,7)}
function getJobColor(job){
  if(job.status==='Cancelled') return '#555870';
  if(job.status==='Pending Payment') return '#e05c5c';
  if(job.team && job.team.toLowerCase().includes('girl')) return '#9b59b6';
  if(job.type==='Tournament'||job.type==='Event') return '#5b8dee';
  if(job.status==='Confirmed'||job.status==='Paid') return '#5cb85c';
  if(job.status==='Needs Coverage') return '#f5a623';
  return STATUS_COLORS[job.status]||'#5b8dee';
}
function getJobDimColor(job){
  const c=getJobColor(job);
  const map={'#555870':'rgba(85,88,112,.18)','#e05c5c':'rgba(224,92,92,.18)','#9b59b6':'rgba(155,89,182,.18)','#5b8dee':'rgba(91,141,238,.18)','#5cb85c':'rgba(92,184,92,.18)','#f5a623':'rgba(245,166,35,.18)'};
  return map[c]||'rgba(91,141,238,.18)';
}
function fmtDate(d){const o={weekday:'short',month:'short',day:'numeric'};return new Date(d+'T00:00:00').toLocaleDateString('en-US',o)}
function fmtDateFull(d){return new Date(d+'T00:00:00').toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric',year:'numeric'})}
function fmtTime(t){if(!t)return'';const[h,m]=t.split(':').map(Number);const ap=h>=12?'PM':'AM';return((h%12)||12)+':'+String(m).padStart(2,'0')+ap}
function pad2(n){return String(n).padStart(2,'0')}
function dateStr(d){return d.getFullYear()+'-'+pad2(d.getMonth()+1)+'-'+pad2(d.getDate())}
function sameDay(a,b){return a.getFullYear()===b.getFullYear()&&a.getMonth()===b.getMonth()&&a.getDate()===b.getDate()}
function timeToMin(t){if(!t)return 0;const[h,m]=t.split(':').map(Number);return h*60+m}
function jobsOverlap(a,b){if(a.date!==b.date||a.id===b.id)return false;const as=timeToMin(a.startTime),ae=timeToMin(a.endTime),bs=timeToMin(b.startTime),be=timeToMin(b.endTime);return as<be&&bs<ae}
function getVgList(j){
  const v=j.assignedVideographer;
  if(!v||v==='Unassigned')return[];
  return v.split(',').map(s=>s.trim()).filter(Boolean);
}
function hasVg(j,name){return getVgList(j).includes(name)}
function isUnassigned(j){return getVgList(j).length===0}
function getConflicts(jobs){
  const conflicts=new Set();
  for(let i=0;i<jobs.length;i++){for(let j=i+1;j<jobs.length;j++){
    const shared=getVgList(jobs[i]).filter(v=>getVgList(jobs[j]).includes(v));
    if(shared.length>0&&jobsOverlap(jobs[i],jobs[j])){
      conflicts.add(jobs[i].id);conflicts.add(jobs[j].id);
    }
  }}
  return conflicts;
}

let S = {
  view:'month',
  currentDate:new Date(),
  jobs:[],
  videographers:[],
  filters:{status:'',vg:'',team:'',type:''},
  rosterOpen:true,
  editingJobId:null,
  selectedDay:null,
  filterVg:null,
  notifications:[],
  assignMode:null,
  lastImportIds:[]
};

/* ===== SUPABASE ===== */
const SUPABASE_URL='https://vxejfbsuwuojghyckmus.supabase.co';
const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ4ZWpmYnN1d3VvamdoeWNrbXVzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1MzczOTcsImV4cCI6MjA4NzExMzM5N30.kiXFHTXIrBKsy75mEs2xbDlUU0_WYbifigVElweHU3s';
let db=null;

async function loadState(){
  if(!db) return false;
  try{
    const [jobsRes,vgRes,notifRes]=await Promise.all([
      db.from('jobs').select('*').order('date',{ascending:true}),
      db.from('videographers').select('*'),
      db.from('notifications').select('*').order('time',{ascending:false}).limit(50)
    ]);
    if(jobsRes.error) throw jobsRes.error;
    if(jobsRes.data) S.jobs=jobsRes.data.map(j=>({
      id:j.id,title:j.title,date:j.date,startTime:j.start_time,endTime:j.end_time,
      type:j.type,team:j.team,assignedVideographer:j.assigned_videographer,
      status:j.status,payAmount:j.pay_amount,notes:j.notes,colorTag:j.color_tag
    }));
    if(vgRes.data) S.videographers=vgRes.data;
    if(notifRes.data) S.notifications=notifRes.data.map(n=>({
      id:n.id,jobTitle:n.job_title,note:n.note,vg:n.vg,time:n.time,read:n.read
    }));
    return true;
  }catch(e){console.error('Supabase load error:',e);return false;}
}

async function saveJob(jobData){
  if(!db) return;
  const row={
    id:jobData.id,title:jobData.title,date:jobData.date,
    start_time:jobData.startTime,end_time:jobData.endTime,
    type:jobData.type,team:jobData.team||'',
    assigned_videographer:jobData.assignedVideographer||'Unassigned',
    status:jobData.status,pay_amount:jobData.payAmount||0,
    notes:jobData.notes||'',color_tag:jobData.colorTag||''
  };
  const {error}=await db.from('jobs').upsert(row);
  if(error) console.error('saveJob error:',error);
}

async function deleteJobFromDB(id){
  if(!db) return;
  await db.from('jobs').delete().eq('id',id);
}

async function saveVideographer(vg){
  if(!db) return;
  await db.from('videographers').upsert(vg);
}

async function saveNotification(n){
  if(!db) return;
  await db.from('notifications').upsert({
    id:n.id,job_title:n.jobTitle,note:n.note,vg:n.vg,time:n.time,read:n.read
  });
}

async function clearAllJobs(){
  if(!db) return;
  await db.from('jobs').delete().neq('id','__none__');
}

async function clearAllNotifications(){
  if(!db) return;
  await db.from('notifications').delete().neq('id','__none__');
}

/* ===== NOTIFICATIONS ===== */
async function addNotification(jobTitle, note, vg){
  const n={id:uid(),jobTitle,note,vg:vg||'',time:Date.now(),read:false};
  S.notifications.unshift(n);
  if(S.notifications.length>50) S.notifications=S.notifications.slice(0,50);
  await saveNotification(n);
  renderNotifBadge();
}
function renderNotifBadge(){
  const unread=S.notifications.filter(n=>!n.read).length;
  const btn=$('notif-btn');
  if(unread>0) btn.classList.add('has-unread'); else btn.classList.remove('has-unread');
  const badge=$('notif-count');
  if(badge){badge.textContent=unread;badge.style.display=unread>0?'inline-block':'none';}
}
function renderNotifPanel(){
  const body=$('notif-body');
  if(!S.notifications.length){
    body.innerHTML='<div class="notif-empty"><div style="font-size:2rem;opacity:.3">üîî</div><div>No notes yet.<br>Notes added to jobs will appear here.</div></div>';
    return;
  }
  const now=Date.now();
  function timeAgo(ts){const s=Math.floor((now-ts)/1000);if(s<60)return'just now';if(s<3600)return Math.floor(s/60)+'m ago';if(s<86400)return Math.floor(s/3600)+'h ago';return Math.floor(s/86400)+'d ago';}
  body.innerHTML=S.notifications.map(n=>`
    <div class="notif-item ${n.read?'read':'unread'}" data-nid="${n.id}">
      <div class="notif-job">üìã ${n.jobTitle}</div>
      <div class="notif-note">"${n.note}"</div>
      <div class="notif-meta"><span>${n.vg||'Unknown'}</span><span>${timeAgo(n.time)}</span></div>
    </div>`).join('');
  body.querySelectorAll('.notif-item').forEach(el=>{
    el.addEventListener('click',async()=>{
      const n=S.notifications.find(x=>x.id===el.dataset.nid);
      if(n&&!n.read){n.read=true;await saveNotification(n);renderNotifBadge();el.classList.replace('unread','read');}
    });
  });
}
async function openNotifPanel(){
  $('notif-panel').classList.add('open');
  renderNotifPanel();
  S.notifications.forEach(n=>n.read=true);
  for(const n of S.notifications){await saveNotification(n);}
  renderNotifBadge();
}
function closeNotifPanel(){$('notif-panel').classList.remove('open');}
async function resetCalendar(){
  if(!confirm('Clear ALL jobs from the calendar? This cannot be undone.'))return;
  await clearAllJobs();
  S.jobs=[];renderAll();
}

function initSampleData(){
  S.videographers=[];
  S.jobs=[];
}

function getFilteredJobs(){
  let jobs=S.jobs.slice();
  if(S.filterVg) jobs=jobs.filter(j=>hasVg(j,S.filterVg));
  if(S.filters.status) jobs=jobs.filter(j=>j.status===S.filters.status);
  if(S.filters.vg) jobs=jobs.filter(j=>hasVg(j,S.filters.vg));
  if(S.filters.team) jobs=jobs.filter(j=>j.team===S.filters.team);
  if(S.filters.type) jobs=jobs.filter(j=>j.type===S.filters.type);
  return jobs;
}
function getJobsForDate(ds){return getFilteredJobs().filter(j=>j.date===ds)}
function getMonthJobs(y,m){return getFilteredJobs().filter(j=>{const d=new Date(j.date+'T00:00:00');return d.getFullYear()===y&&d.getMonth()===m})}
/* ===== RENDER ===== */
const $=id=>document.getElementById(id);
const conflicts=()=>getConflicts(S.jobs);

function renderAll(){
  renderFilmstrip();renderStats();renderCoverageAlert();renderRoster();renderFilterDropdowns();renderActiveFilters();renderNavLabel();renderCalendar();
  const banner=$('assign-banner');
  if(S.assignMode){
    const unassigned=S.jobs.filter(j=>isUnassigned(j)&&j.status!=='Cancelled').length;
    $('assign-text').textContent='üéØ Assign mode: Click unassigned games to assign to '+S.assignMode+' ('+unassigned+' available)';
    banner.classList.add('show');
  } else {
    banner.classList.remove('show');
  }
}

function renderFilmstrip(){
  const el=$('fsh');if(!el)return;let h='';for(let i=0;i<80;i++)h+='<div class="fs-hole"></div>';el.innerHTML=h;
}

function renderStats(){
  const now=S.currentDate,y=now.getFullYear(),m=now.getMonth();
  const mj=S.jobs.filter(j=>{const d=new Date(j.date+'T00:00:00');return d.getFullYear()===y&&d.getMonth()===m&&j.status!=='Cancelled'});
  const rev=mj.reduce((s,j)=>s+(j.payAmount||0),0);
  const paid=mj.filter(j=>j.status==='Paid').reduce((s,j)=>s+(j.payAmount||0),0);
  const pend=rev-paid;
  $('sv-j').textContent=mj.length;
  $('ss-j').textContent=mj.filter(j=>j.status==='Confirmed'||j.status==='Paid').length+' confirmed';
  $('sv-r').textContent='$'+rev.toLocaleString();
  $('sv-p').textContent='$'+paid.toLocaleString();
  $('ss-p').textContent=mj.filter(j=>j.status==='Paid').length+' jobs paid';
  $('sv-d').textContent='$'+pend.toLocaleString();
  $('ss-d').textContent=mj.filter(j=>j.status==='Pending Payment').length+' invoices';
}

function renderCoverageAlert(){
  const now=new Date(),end=new Date(now);end.setDate(end.getDate()+7);
  const needs=S.jobs.filter(j=>{const d=new Date(j.date+'T00:00:00');return d>=now&&d<=end&&(j.status==='Needs Coverage'||isUnassigned(j))&&j.status!=='Cancelled'});
  const el=$('cov-alert'),tx=$('cov-text');
  if(needs.length>0){el.classList.add('show');tx.textContent=needs.length+' game'+(needs.length>1?'s':'')+' need'+(needs.length===1?'s':'')+' coverage this week';}
  else el.classList.remove('show');
}

function renderRoster(){
  const body=$('ros-body');if(!body)return;
  const cf=conflicts();const y=S.currentDate.getFullYear(),m=S.currentDate.getMonth();
  let h='';
  S.videographers.forEach(v=>{
    const vJobs=S.jobs.filter(j=>{const d=new Date(j.date+'T00:00:00');return d.getFullYear()===y&&d.getMonth()===m&&hasVg(j,v.name)&&j.status!=='Cancelled'});
    const earned=vJobs.filter(j=>j.status==='Paid').reduce((s,j)=>s+(j.payAmount||0),0);
    const total=vJobs.reduce((s,j)=>s+(j.payAmount||0),0);
    const paidC=vJobs.filter(j=>j.status==='Paid').length;
    const pendC=vJobs.filter(j=>j.status!=='Paid'&&j.status!=='Cancelled').length;
    const pct=total>0?Math.round(earned/total*100):0;
    const isActive=S.filterVg===v.name;
    const isAssigning=S.assignMode===v.name;
    const init=v.name.split(' ').map(w=>w[0]).join('').toUpperCase();
    h+='<div class="vgc'+(isActive?' active':'')+(isAssigning?' assign-mode':'')+'" data-vg="'+v.name+'">';
    h+='<div class="vgc-top"><div class="vgc-dot" style="background:'+v.color+'">'+init+'</div><div class="vgc-name">'+v.name+'</div><span class="assign-badge">ASSIGNING</span></div>';
    h+='<div class="vgc-stats"><div class="vgc-st">Jobs: <span>'+vJobs.length+'</span></div><div class="vgc-st">Earned: <span>$'+earned+'</span></div>';
    h+='<div class="vgc-st">Paid: <span>'+paidC+'</span></div><div class="vgc-st">Pending: <span>'+pendC+'</span></div></div>';
    h+='<div class="vgc-bar"><div class="vgc-bar-f" style="width:'+pct+'%"></div></div></div>';
  });
  body.innerHTML=h;
  body.querySelectorAll('.vgc').forEach(el=>{
    el.addEventListener('click',()=>{
      const name=el.dataset.vg;
      if(S.assignMode){
        // If already in assign mode, clicking any card exits or switches
        S.assignMode=S.assignMode===name?null:name;
      } else {
        S.filterVg=S.filterVg===name?null:name;
      }
      renderAll();
    });
    el.addEventListener('dblclick',(e)=>{
      e.preventDefault();
      const name=el.dataset.vg;
      S.assignMode=S.assignMode===name?null:name;
      S.filterVg=null;
      renderAll();
    });
  });
}

function renderFilterDropdowns(){
  const vgSel=$('f-vg'),tmSel=$('f-team');
  const vgOpts=['<option value="">All Videographers</option>'];
  S.videographers.forEach(v=>vgOpts.push('<option value="'+v.name+'"'+(S.filters.vg===v.name?' selected':'')+'>'+v.name+'</option>'));
  vgSel.innerHTML=vgOpts.join('');
  const teams=[...new Set(S.jobs.map(j=>j.team).filter(Boolean))].sort();
  const tmOpts=['<option value="">All Teams</option>'];
  teams.forEach(t=>tmOpts.push('<option value="'+t+'"'+(S.filters.team===t?' selected':'')+'>'+t+'</option>'));
  tmSel.innerHTML=tmOpts.join('');
  $('f-status').value=S.filters.status||'';
  $('f-type').value=S.filters.type||'';
}

function renderActiveFilters(){
  const el=$('af-chips'),clr=$('btn-clr');let h='';let any=false;
  if(S.filterVg){h+='<span class="af-chip">üë§ '+S.filterVg+'<button onclick="S.filterVg=null;renderAll()">‚úï</button></span>';any=true;}
  Object.entries(S.filters).forEach(([k,v])=>{if(v){h+='<span class="af-chip">'+k+': '+v+'<button onclick="S.filters.'+k+'=\'\';renderAll()">‚úï</button></span>';any=true;}});
  el.innerHTML=h;clr.style.display=any?'inline':'none';
}

function renderNavLabel(){
  const d=S.currentDate,mo=d.toLocaleString('en-US',{month:'long'}),yr=d.getFullYear();
  if(S.view==='month') $('nav-label').textContent=mo+' '+yr;
  else if(S.view==='week'){
    const start=getWeekStart(d),end=new Date(start);end.setDate(end.getDate()+6);
    $('nav-label').textContent=start.toLocaleDateString('en-US',{month:'short',day:'numeric'})+' ‚Äì '+end.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});
  } else $('nav-label').textContent=mo+' '+yr;
}

function getWeekStart(d){const dt=new Date(d);const day=dt.getDay();const diff=day===0?-6:1-day;dt.setDate(dt.getDate()+diff);return dt}

function renderCalendar(){
  const el=$('cal');if(!el)return;
  if(S.view==='month') renderMonth(el);
  else if(S.view==='week') renderWeek(el);
  else renderList(el);
}

function renderMonth(el){
  const d=S.currentDate,y=d.getFullYear(),m=d.getMonth();
  const first=new Date(y,m,1),last=new Date(y,m+1,0);
  const startDay=first.getDay()||7;
  const cf=conflicts();
  const today=new Date();
  let h='<div class="mgrid">';
  ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'].forEach(d=>h+='<div class="mhdr">'+d+'</div>');
  const startDate=new Date(first);startDate.setDate(startDate.getDate()-(startDay-1));
  for(let i=0;i<42;i++){
    const cur=new Date(startDate);cur.setDate(startDate.getDate()+i);
    const ds=dateStr(cur);
    const isOther=cur.getMonth()!==m;
    const isToday=sameDay(cur,today);
    const dayJobs=getJobsForDate(ds);
    h+='<div class="mday'+(isOther?' om':'')+(isToday?' today':'')+'" data-date="'+ds+'">';
    h+='<div class="dnum">'+cur.getDate()+'</div>';
    const show=dayJobs.slice(0,3);
    show.forEach(j=>{
      const c=getJobColor(j);const hasCf=cf.has(j.id);
      const canAssign=S.assignMode&&!hasVg(j,S.assignMode)&&j.status!=='Cancelled';
      h+='<div class="dpill'+(canAssign?' assignable':'')+'" style="background:'+c+'" data-id="'+j.id+'" title="'+(canAssign?'Click to assign '+S.assignMode:((hasCf?'‚ö† Schedule conflict\n':'')+j.title))+'">'+(hasCf?'‚ö† ':'')+j.title+'</div>';
    });
    if(dayJobs.length>3) h+='<div class="dmore">+'+(dayJobs.length-3)+' more</div>';
    h+='</div>';
  }
  h+='</div>';
  el.innerHTML=h;
  el.querySelectorAll('.mday').forEach(d=>d.addEventListener('click',e=>{
    if(e.target.classList.contains('dpill')){
      if(S.assignMode&&e.target.classList.contains('assignable')){
        assignVgToJob(e.target.dataset.id,S.assignMode);return;
      }
      openEditModal(e.target.dataset.id);return;
    }
    if(e.target.classList.contains('dmore')){openDayPanel(d.dataset.date);return;}
    if(!S.assignMode) openDayPanel(d.dataset.date);
  }));
}

function renderWeek(el){
  const start=getWeekStart(S.currentDate);
  const cf=conflicts();const today=new Date();
  let h='<div class="ww"><div class="wtc"><div class="wth"></div>';
  for(let hr=6;hr<=22;hr++) h+='<div class="wts">'+fmtTime(pad2(hr)+':00')+'</div>';
  h+='</div>';
  for(let d=0;d<7;d++){
    const cur=new Date(start);cur.setDate(start.getDate()+d);
    const ds=dateStr(cur);const isToday=sameDay(cur,today);
    const dayJobs=getJobsForDate(ds);
    h+='<div class="wdc" style="border-left:1px solid var(--border)">';
    h+='<div class="wdh'+(isToday?' today':'')+'" data-date="'+ds+'"><div class="wdn">'+cur.toLocaleDateString('en-US',{weekday:'short'})+'</div><div class="wdd">'+cur.getDate()+'</div></div>';
    h+='<div class="wsa">';
    for(let hr=6;hr<=22;hr++) h+='<div class="wsbg"></div>';
    dayJobs.forEach(j=>{
      const s=timeToMin(j.startTime||'09:00'),e=timeToMin(j.endTime||'11:00');
      const top=((s-360)/60)*48,height=Math.max(((e-s)/60)*48,20);
      const c=getJobColor(j);const hasCf=cf.has(j.id);
      const canAssign=S.assignMode&&!hasVg(j,S.assignMode)&&j.status!=='Cancelled';
      h+='<div class="wev'+(canAssign?' assignable':'')+'" style="top:'+top+'px;height:'+height+'px;background:'+c+'" data-id="'+j.id+'" title="'+(canAssign?'Click to assign '+S.assignMode:((hasCf?'‚ö† Conflict\n':'')+j.title))+'">';
      h+='<div class="wet">'+(hasCf?'‚ö† ':'')+j.title+'</div>';
      h+='<div class="weti">'+fmtTime(j.startTime)+' ‚Äì '+fmtTime(j.endTime)+'</div></div>';
    });
    h+='</div></div>';
  }
  h+='</div>';
  el.innerHTML=h;
  el.querySelectorAll('.wev').forEach(e=>e.addEventListener('click',()=>{
    if(S.assignMode&&e.classList.contains('assignable')){assignVgToJob(e.dataset.id,S.assignMode);return;}
    openEditModal(e.dataset.id);
  }));
  el.querySelectorAll('.wdh').forEach(e=>e.addEventListener('click',()=>{if(!S.assignMode)openDayPanel(e.dataset.date)}));
}

function renderList(el){
  const jobs=getFilteredJobs().sort((a,b)=>a.date.localeCompare(b.date)||a.startTime.localeCompare(b.startTime));
  if(!jobs.length){el.innerHTML='<div class="empty"><div class="empty-i">üì≠</div><div class="empty-t">No jobs match your filters</div></div>';return;}
  const cf=conflicts();const today=new Date();const groups={};
  jobs.forEach(j=>{if(!groups[j.date])groups[j.date]=[];groups[j.date].push(j)});
  let h='';
  Object.keys(groups).sort().forEach(date=>{
    const isToday=sameDay(new Date(date+'T00:00:00'),today);
    h+='<div class="lg"><div class="ldh"><span class="ldl">'+fmtDate(date)+'</span><div class="ldline"></div>'+(isToday?'<span class="tbd">TODAY</span>':'')+'</div>';
    groups[date].forEach(j=>{
      const c=getJobColor(j);const hasCf=cf.has(j.id);
      h+='<div class="jc" data-id="'+j.id+'">';
      h+='<div class="jcb" style="background:'+c+'"></div>';
      h+='<div class="jcm"><div class="jct">'+j.title+(hasCf?' <span class="cfb">‚ö† Conflict</span>':'')+'</div>';
      h+='<div class="jcmeta">';
      h+='<span class="jcmi">üïê '+fmtTime(j.startTime)+' ‚Äì '+fmtTime(j.endTime)+'</span>';
      if(j.team) h+='<span class="jcmi">üèà '+j.team+'</span>';
      h+='<span class="jcmi">üé¨ '+j.type+'</span>';
      if(!isUnassigned(j)) h+='<span class="jcmi">üë§ '+getVgList(j).join(', ')+'</span>';
      h+='</div>';
      h+=renderPaymentTimeline(j);
      h+='</div><div class="jcr">';
      h+='<span class="sbadge" style="background:'+STATUS_DIM[j.status]+';color:'+STATUS_COLORS[j.status]+'">'+j.status+'</span>';
      if(j.payAmount) h+='<span class="payamt">$'+j.payAmount+'</span>';
      h+='</div></div>';
    });
    h+='</div>';
  });
  el.innerHTML=h;
  el.querySelectorAll('.jc').forEach(e=>e.addEventListener('click',()=>openEditModal(e.dataset.id)));
}

function renderPaymentTimeline(j){
  const steps=[{label:'Delivered',done:['Delivered','Paid','Pending Payment'].includes(j.status)},{label:'Invoiced',done:['Paid','Pending Payment'].includes(j.status)},{label:'Paid',done:j.status==='Paid'}];
  if(j.status==='Needs Coverage'||j.status==='Confirmed'||j.status==='In Progress'||j.status==='Cancelled')return'';
  let h='<div class="ptl">';
  steps.forEach((s,i)=>{
    h+='<span class="pts'+(s.done?' dn':'')+((!s.done&&i>0&&steps[i-1].done)?' ac':'')+'">'+(s.done?'‚úì':'‚óã')+' '+s.label+'</span>';
    if(i<steps.length-1) h+='<span class="pta">‚Üí</span>';
  });
  return h+'</div>';
}
/* ===== MODALS & EVENTS ===== */
function openNewModal(date){
  S.editingJobId=null;
  $('mdl-title').textContent='New Job';
  $('m-title').value='';$('m-date').value=date||dateStr(new Date());
  $('m-start').value='09:00';$('m-end').value='11:00';
  $('m-type').value='Game Coverage';$('m-team').value='';
  $('m-status').value='Needs Coverage';$('m-pay').value='';$('m-notes').value='';
  populateVgSelect([]);
  $('mdl-del').style.display='none';
  clearFormErrors();
  $('mo').classList.add('open');
}

function openEditModal(id){
  const j=S.jobs.find(x=>x.id===id);if(!j)return;
  S.editingJobId=id;
  $('mdl-title').textContent='Edit Job';
  $('m-title').value=j.title;$('m-date').value=j.date;
  $('m-start').value=j.startTime||'09:00';$('m-end').value=j.endTime||'11:00';
  $('m-type').value=j.type;$('m-team').value=j.team||'';
  $('m-status').value=j.status;$('m-pay').value=j.payAmount||'';$('m-notes').value=j.notes||'';
  populateVgSelect(getVgList(j));
  $('mdl-del').style.display='inline-flex';
  clearFormErrors();
  $('mo').classList.add('open');
}

function closeModal(){$('mo').classList.remove('open');S.editingJobId=null}

function populateVgSelect(selected){
  const sel=selected||[];
  let h='';
  S.videographers.forEach(v=>{
    const checked=sel.includes(v.name)?'checked':'';
    h+='<label><input type="checkbox" value="'+v.name+'" '+checked+'> '+v.name+'</label>';
  });
  $('m-vg-dd').innerHTML=h;
  updateVgDisplay();
  $('m-vg-dd').querySelectorAll('input').forEach(cb=>cb.addEventListener('change',()=>{
    updateVgDisplay();
    // Auto-set status
    const names=getSelectedVgs();
    const status=$('m-status').value;
    if(names.length>0&&status==='Needs Coverage') $('m-status').value='Pending Payment';
    else if(names.length===0&&status==='Pending Payment') $('m-status').value='Needs Coverage';
  }));
}
function getSelectedVgs(){
  return [...$('m-vg-dd').querySelectorAll('input:checked')].map(cb=>cb.value);
}
function updateVgDisplay(){
  const names=getSelectedVgs();
  $('m-vg-display').textContent=names.length?names.join(', '):'Unassigned';
  $('m-vg-display').style.color=names.length?'var(--text)':'var(--text3)';
}

async function assignVgToJob(jobId,vgName){
  const idx=S.jobs.findIndex(j=>j.id===jobId);
  if(idx<0)return;
  const existing=getVgList(S.jobs[idx]);
  if(!existing.includes(vgName)) existing.push(vgName);
  S.jobs[idx].assignedVideographer=existing.join(', ');
  if(S.jobs[idx].status==='Needs Coverage') S.jobs[idx].status='Pending Payment';
  await saveJob(S.jobs[idx]);
  renderAll();
}

function exitAssignMode(){S.assignMode=null;renderAll();}

function clearFormErrors(){
  document.querySelectorAll('.ferr').forEach(e=>e.classList.remove('show'));
}

async function saveJobModal(){
  clearFormErrors();let valid=true;
  const title=$('m-title').value.trim();
  const date=$('m-date').value;
  if(!title){$('e-title').classList.add('show');valid=false}
  if(!date){$('e-date').classList.add('show');valid=false}
  if(!valid)return;
  const data={
    title,date,
    startTime:$('m-start').value,endTime:$('m-end').value,
    type:$('m-type').value,team:$('m-team').value.trim(),
    assignedVideographer:getSelectedVgs().join(', ')||'Unassigned',
    status:$('m-status').value,
    payAmount:parseFloat($('m-pay').value)||0,
    notes:$('m-notes').value.trim(),
    colorTag:''
  };
  let jobData;
  if(S.editingJobId){
    const idx=S.jobs.findIndex(j=>j.id===S.editingJobId);
    if(idx>=0){
      const prev=S.jobs[idx];
      if(data.notes&&data.notes!==prev.notes){
        await addNotification(data.title||prev.title,data.notes,data.assignedVideographer||prev.assignedVideographer);
      }
      jobData={...prev,...data};
      S.jobs[idx]=jobData;
    }
  } else {
    if(data.notes) await addNotification(data.title,data.notes,data.assignedVideographer);
    jobData={id:uid(),...data};
    S.jobs.push(jobData);
  }
  await saveJob(jobData);
  closeModal();renderAll();
}

async function deleteJob(){
  if(!S.editingJobId)return;
  if(!confirm('Delete this job?'))return;
  await deleteJobFromDB(S.editingJobId);
  S.jobs=S.jobs.filter(j=>j.id!==S.editingJobId);
  closeModal();renderAll();
}

function openDayPanel(ds){
  S.selectedDay=ds;
  $('dp-title').textContent=fmtDateFull(ds);
  const jobs=getJobsForDate(ds).sort((a,b)=>(a.startTime||'').localeCompare(b.startTime||''));
  let h='';
  if(!jobs.length) h='<div style="color:var(--text3);font-size:.82rem;padding:20px;text-align:center">No jobs this day</div>';
  jobs.forEach(j=>{
    const c=getJobColor(j);
    h+='<div class="dpj" style="border-left-color:'+c+'" data-id="'+j.id+'">';
    h+='<div class="dpjt">'+j.title+'</div>';
    h+='<div class="dpjm">'+fmtTime(j.startTime)+' ‚Äì '+fmtTime(j.endTime);
    if(!isUnassigned(j)) h+=' ¬∑ '+getVgList(j).join(', ');
    h+='</div><div class="dpjm" style="margin-top:3px"><span class="sbadge" style="background:'+STATUS_DIM[j.status]+';color:'+STATUS_COLORS[j.status]+'">'+j.status+'</span></div>';
    h+='</div>';
  });
  h+='<button class="btn btn-p" style="width:100%;margin-top:10px" onclick="closeDayPanel();openNewModal(\''+ds+'\')">Ôºã Add Job</button>';
  $('dp-body').innerHTML=h;
  $('dp').classList.add('open');
  $('dp-body').querySelectorAll('.dpj').forEach(e=>e.addEventListener('click',()=>{closeDayPanel();openEditModal(e.dataset.id)}));
}

function closeDayPanel(){$('dp').classList.remove('open');S.selectedDay=null}

function openVgModal(){
  $('vm-name').value='';
  document.querySelectorAll('#ve-name').forEach(e=>e.classList.remove('show'));
  const colEl=$('vm-colors');let h='';
  VG_COLORS.forEach((c,i)=>h+='<div style="width:24px;height:24px;border-radius:50%;background:'+c+';cursor:pointer;border:2px solid '+(i===0?'#fff':'transparent')+';transition:all .2s" data-color="'+c+'" class="vmc'+(i===0?' sel':'')+'"></div>');
  colEl.innerHTML=h;
  colEl.querySelectorAll('[data-color]').forEach(el=>el.addEventListener('click',()=>{
    colEl.querySelectorAll('[data-color]').forEach(x=>{x.style.borderColor='transparent';x.classList.remove('sel')});
    el.style.borderColor='#fff';el.classList.add('sel');
  }));
  $('vmo').classList.add('open');
}

function closeVgModal(){$('vmo').classList.remove('open')}

async function saveVg(){
  const name=$('vm-name').value.trim();
  if(!name){$('ve-name').classList.add('show');return}
  const selColor=document.querySelector('.vmc.sel');
  const color=selColor?selColor.dataset.color:VG_COLORS[Math.floor(Math.random()*VG_COLORS.length)];
  const vg={id:uid(),name,color};
  S.videographers.push(vg);
  await saveVideographer(vg);
  closeVgModal();renderAll();
}

function exportCSV(){
  const headers=['Title','Date','Start','End','Type','Team','Videographer','Status','Pay','Notes'];
  let csv=headers.join(',')+'\n';
  S.jobs.forEach(j=>{
    csv+=[j.title,j.date,j.startTime,j.endTime,j.type,j.team||'','"'+(j.assignedVideographer||'')+'"',j.status,j.payAmount||0,'"'+(j.notes||'').replace(/"/g,'""')+'"'].join(',')+'\n';
  });
  const blob=new Blob([csv],{type:'text/csv'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='lax_jobs_export.csv';a.click();
}

/* ===== PASTE SCHEDULE PARSER ===== */
function openPasteModal(){
  $('paste-input').value='';
  $('p-team').value='';
  $('p-year').value=new Date().getFullYear();
  $('p-start').value='';
  $('p-end').value='';
  $('parse-preview').style.display='none';
  $('mass-controls').style.display='none';
  $('btn-import').style.display='none';
  $('import-status').textContent='';
  $('parse-tbody').innerHTML='';
  document.querySelectorAll('[data-mass-status]').forEach(b=>b.classList.remove('mc-confirmed','mc-needs','mc-cancelled','mc-pending','mc-inprog'));
  document.querySelectorAll('.color-dot').forEach(d=>d.classList.remove('sel'));
  $('pmo').classList.add('open');
  setTimeout(()=>$('paste-input').focus(),100);
}
function closePasteModal(){$('pmo').classList.remove('open')}

function parseTime(raw){
  if(!raw)return{start:'09:00',end:'11:00'};
  raw=raw.trim().toLowerCase();
  const m=raw.match(/(\d{1,2})(?::(\d{2}))?\s*(am|pm)?/i);
  if(!m)return{start:'09:00',end:'11:00'};
  let h=parseInt(m[1]),min=parseInt(m[2]||0);
  const ap=m[3]?m[3].toLowerCase():'';
  if(ap==='pm'&&h!==12)h+=12;
  if(ap==='am'&&h===12)h=0;
  if(!ap&&h<6)h+=12;
  const start=pad2(h)+':'+pad2(min);
  const endH=h+2;
  const end=pad2(endH>23?23:endH)+':'+pad2(min);
  return{start,end};
}

function parseScheduleLine(line, fallbackYear){
  line=line.replace(/^[-‚Ä¢*]\s*/,'').trim();
  if(!line||line.length<5)return null;

  const MN={jan:1,january:1,feb:2,february:2,mar:3,march:3,apr:4,april:4,may:5,jun:6,june:6,jul:7,july:7,aug:8,august:8,sep:9,sept:9,september:9,oct:10,october:10,nov:11,november:11,dec:12,december:12};
  const mPat='(?:jan(?:uary)?|feb(?:ruary)?|mar(?:ch)?|apr(?:il)?|may|june?|july?|aug(?:ust)?|sept?(?:ember)?|oct(?:ober)?|nov(?:ember)?|dec(?:ember)?)';
  const year=parseInt(fallbackYear)||new Date().getFullYear();

  function parseMon(s){return MN[s.toLowerCase().replace(/\.$/,'')]||0}
  function makeDateVal(y,m,d){return y+'-'+pad2(m)+'-'+pad2(d)}
  function expandRange(startDate,endDate){
    const dates=[];const cur=new Date(startDate+'T00:00:00');const last=new Date(endDate+'T00:00:00');
    if(isNaN(cur)||isNaN(last)||last<cur||last-cur>30*86400000)return[startDate];
    while(cur<=last){dates.push(dateStr(cur));cur.setDate(cur.getDate()+1);}
    return dates;
  }

  let month=0,day=0,endDay=0,endMonth=0,dateVal='',endDateVal='',dateMatchStr='';

  // Range: "June 10-12", "June 10th-12th", "Jun 10 - Jun 14", "June 10-June 14"
  const rangeTextRx=new RegExp('\\b('+mPat+')\\s+(\\d{1,2})(?:st|nd|rd|th)?\\s*[-‚Äì]\\s*(?:('+mPat+')\\s+)?(\\d{1,2})(?:st|nd|rd|th)?(?:\\s*,?\\s*(\\d{4}))?\\b','i');
  const rangeTextM=line.match(rangeTextRx);
  // Range: "6/10-6/12", "6/10-12"
  const rangeNumRx=/\b(\d{1,2})[\/](\d{1,2})\s*[-‚Äì]\s*(?:(\d{1,2})[\/])?(\d{1,2})\b/;
  const rangeNumM=line.match(rangeNumRx);

  // Try YYYY-MM-DD
  const isoRx=/\b(\d{4})-(\d{1,2})-(\d{1,2})\b/;
  const isoM=line.match(isoRx);
  // Try MM/DD/YYYY
  const fullRx=/\b(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})\b/;
  const fullM=line.match(fullRx);
  // Try text date: "June 14", "Jun 15th", "June 14, 2025"
  const textRx=new RegExp('\\b('+mPat+')\\s+(\\d{1,2})(?:st|nd|rd|th)?(?:\\s*,?\\s*(\\d{4}))?\\b','i');
  const textM=line.match(textRx);
  // Try numeric M/D
  const numRx=/\b(\d{1,2})[\/\-](\d{1,2})\b/;
  const numM=line.match(numRx);

  if(rangeTextM){
    month=parseMon(rangeTextM[1]);day=parseInt(rangeTextM[2]);
    endMonth=rangeTextM[3]?parseMon(rangeTextM[3]):month;
    endDay=parseInt(rangeTextM[4]);
    const yr=rangeTextM[5]?parseInt(rangeTextM[5]):year;
    dateVal=makeDateVal(yr,month,day);
    endDateVal=makeDateVal(yr,endMonth,endDay);
    dateMatchStr=rangeTextM[0];
  } else if(rangeNumM){
    month=parseInt(rangeNumM[1]);day=parseInt(rangeNumM[2]);
    endMonth=rangeNumM[3]?parseInt(rangeNumM[3]):month;
    endDay=parseInt(rangeNumM[4]);
    dateVal=makeDateVal(year,month,day);
    endDateVal=makeDateVal(year,endMonth,endDay);
    dateMatchStr=rangeNumM[0];
  } else if(isoM){
    month=parseInt(isoM[2]);day=parseInt(isoM[3]);
    dateVal=isoM[1]+'-'+pad2(month)+'-'+pad2(day);
    dateMatchStr=isoM[0];
  } else if(fullM){
    month=parseInt(fullM[1]);day=parseInt(fullM[2]);
    dateVal=fullM[3]+'-'+pad2(month)+'-'+pad2(day);
    dateMatchStr=fullM[0];
  } else if(textM){
    month=parseMon(textM[1]);day=parseInt(textM[2]);
    const yr=textM[3]?parseInt(textM[3]):year;
    if(month&&day) dateVal=makeDateVal(yr,month,day);
    dateMatchStr=textM[0];
  } else if(numM){
    month=parseInt(numM[1]);day=parseInt(numM[2]);
    dateVal=makeDateVal(year,month,day);
    dateMatchStr=numM[0];
  }

  if(!dateVal||month<1||month>12||day<1||day>31)return null;

  // Extract time
  const timeRx=/\b(\d{1,2}(?::\d{2})?\s*(?:am|pm))/i;
  const timeM=line.match(timeRx);
  const {start,end}=parseTime(timeM?timeM[1]:'');

  // Extract title
  let title=line;
  title=title.replace(/^(monday|tuesday|wednesday|thursday|friday|saturday|sunday),?\s*/i,'');
  if(dateMatchStr) title=title.replace(dateMatchStr,'');
  title=title.replace(/[-‚Äì]\s*\d{1,2}(?::\d{2})?\s*(?:am|pm)?\s*/i,'');
  title=title.replace(/\bat\s+\d{1,2}(?::\d{2})?\s*(?:am|pm)?\s*/i,'');
  title=title.replace(/^[-‚Äì\s,@]+/,'').replace(/[-‚Äì\s,]+$/,'').trim();
  if(title) title=title.charAt(0).toUpperCase()+title.slice(1);

  // Expand date range into multiple results
  const dates=endDateVal?expandRange(dateVal,endDateVal):[dateVal];
  return dates.map((d,i)=>{
    const dayTitle=title||(dates.length>1?'Day '+(i+1)+' ‚Äì '+fmtDate(d):'Game '+fmtDate(d));
    return{title:dates.length>1?(title?title+' (Day '+(i+1)+')':dayTitle):title||'Game '+fmtDate(d),date:d,startTime:start,endTime:end,type:'Game Coverage'};
  });
}

const AVAIL_OPTIONS=[
  {key:'yes',label:'‚úì Yes',cls:'sel-yes'},
  {key:'no',label:'‚úó No',cls:'sel-no'},
  {key:'maybe',label:'? Maybe',cls:'sel-maybe'},
  {key:'pending',label:'‚è≥ Pending',cls:'sel-pending'}
];

function makeAvailChips(i){
  return AVAIL_OPTIONS.map(a=>`<button class="avail-chip" data-avail="${a.key}" data-row="${i}">${a.label}</button>`).join('');
}

function applyAvailChipListeners(tbody){
  tbody.querySelectorAll('.avail-chip').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const row=btn.dataset.row;
      tbody.querySelectorAll(`.avail-chip[data-row="${row}"]`).forEach(b=>{
        AVAIL_OPTIONS.forEach(a=>b.classList.remove(a.cls));
      });
      const opt=AVAIL_OPTIONS.find(a=>a.key===btn.dataset.avail);
      if(opt) btn.classList.add(opt.cls);
      btn.closest('tr').dataset.avail=btn.dataset.avail;
    });
  });
}

const COLOR_PALETTE=[
  {color:'#5cb85c',label:'Green'},
  {color:'#f5a623',label:'Amber'},
  {color:'#e05c5c',label:'Red'},
  {color:'#5b8dee',label:'Blue'},
  {color:'#9b59b6',label:'Purple'},
  {color:'#4ecdc4',label:'Teal'},
  {color:'#e67e22',label:'Orange'},
  {color:'#1abc9c',label:'Mint'},
  {color:'#555870',label:'Gray'}
];

function initMassControls(){
  const dotsEl=$('mass-color-dots');
  let h='';
  COLOR_PALETTE.forEach(c=>h+=`<div class="color-dot" data-color="${c.color}" style="background:${c.color}" title="${c.label}"></div>`);
  dotsEl.innerHTML=h;

  dotsEl.querySelectorAll('.color-dot').forEach(dot=>{
    dot.addEventListener('click',()=>{
      dotsEl.querySelectorAll('.color-dot').forEach(d=>d.classList.remove('sel'));
      dot.classList.add('sel');
      const col=dot.dataset.color;
      document.querySelectorAll('#parse-tbody tr').forEach(row=>{
        row.dataset.color=col;
        const pill=row.querySelector('.color-preview');
        if(pill) pill.style.background=col;
      });
    });
  });

  $('mass-color-clear').addEventListener('click',()=>{
    dotsEl.querySelectorAll('.color-dot').forEach(d=>d.classList.remove('sel'));
    document.querySelectorAll('#parse-tbody tr').forEach(row=>{
      row.dataset.color='';
      const pill=row.querySelector('.color-preview');
      if(pill) pill.style.background='var(--border)';
    });
  });

  // Mass VG selector
  const massVgEl=$('mass-vg');
  massVgEl.innerHTML='<option value="Unassigned">Unassigned</option>'+S.videographers.map(v=>`<option value="${v.name}">${v.name}</option>`).join('');
  massVgEl.addEventListener('change',()=>{
    const val=massVgEl.value;
    document.querySelectorAll('#parse-tbody tr').forEach(row=>{
      const sel=row.querySelector('[data-field="vg"]');
      if(sel) sel.value=val;
    });
  });

  const MC={'Confirmed':'mc-confirmed','Needs Coverage':'mc-needs','Cancelled':'mc-cancelled','Pending Payment':'mc-pending','In Progress':'mc-inprog'};
  document.querySelectorAll('[data-mass-status]').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const status=btn.dataset.massStatus;
      const cls=MC[status]||'';
      const isOn=btn.classList.contains(cls);
      if(isOn){
        btn.classList.remove(cls);
      } else {
        btn.classList.add(cls);
      }
      const activeStatuses=[...document.querySelectorAll('[data-mass-status]')]
        .filter(b=>b.classList.contains(MC[b.dataset.massStatus]||'__'))
        .map(b=>b.dataset.massStatus);
      document.querySelectorAll('#parse-tbody tr').forEach(row=>{
        const sel=row.querySelector('[data-field="status"]');
        if(activeStatuses.length===1&&sel){
          sel.value=activeStatuses[0];
          row.dataset.status=activeStatuses[0];
        }
      });
    });
  });
}

function parseSchedule(){
  const raw=$('paste-input').value;
  const year=$('p-year').value||new Date().getFullYear();
  const overrideStart=$('p-start').value;
  const overrideEnd=$('p-end').value;
  const lines=raw.split('\n');
  const results=[];
  lines.forEach(line=>{
    const r=parseScheduleLine(line,year);
    if(r) results.push(...r);
  });
  const tbody=$('parse-tbody');
  if(!results.length){
    tbody.innerHTML='<tr><td colspan="7" style="color:var(--text3);text-align:center;padding:20px">No dates detected. Make sure each line has a date like 2/24 or 3/15.</td></tr>';
    $('parse-preview').style.display='block';
    $('btn-import').style.display='none';
    $('parse-count').textContent='0';
    return;
  }
  $('parse-count').textContent=results.length;
  let rows='';
  const statusOpts=STATUSES.map(s=>`<option>${s}</option>`).join('');
  const vgOpts='<option value="Unassigned">Unassigned</option>'+S.videographers.map(v=>`<option value="${v.name}">${v.name}</option>`).join('');
  results.forEach((r,i)=>{
    const st=overrideStart||r.startTime;
    const et=overrideEnd||r.endTime;
    rows+=`<tr data-idx="${i}" data-avail="" data-color="" data-status="Needs Coverage">
      <td><input class="pi" data-field="title" value="${r.title.replace(/"/g,'&quot;')}" style="min-width:150px"></td>
      <td><input class="pi" data-field="date" type="date" value="${r.date}" style="min-width:105px"></td>
      <td><input class="pi" data-field="startTime" type="time" value="${st}"></td>
      <td><input class="pi" data-field="endTime" type="time" value="${et}"></td>
      <td><select class="ps" data-field="status" style="min-width:100px">${statusOpts}</select></td>
      <td><select class="ps" data-field="vg" style="min-width:100px">${vgOpts}</select></td>
      <td><div class="color-preview" style="width:18px;height:18px;border-radius:50%;background:var(--border);border:2px solid var(--border2);cursor:default"></div></td>
      <td><div class="avail-chips">${makeAvailChips(i)}</div></td>
      <td><button class="row-del" title="Remove">‚úï</button></td>
    </tr>`;
  });
  tbody.innerHTML=rows;
  applyAvailChipListeners(tbody);
  tbody.querySelectorAll('.row-del').forEach(btn=>btn.addEventListener('click',()=>{
    btn.closest('tr').remove();
    const remaining=tbody.querySelectorAll('tr').length;
    $('parse-count').textContent=remaining;
    if(!remaining) $('btn-import').style.display='none';
  }));
  $('parse-preview').style.display='block';
  $('mass-controls').style.display='block';
  document.querySelectorAll('[data-mass-status]').forEach(b=>b.classList.remove('mc-confirmed','mc-needs','mc-cancelled','mc-pending','mc-inprog'));
  document.querySelectorAll('.color-dot').forEach(d=>d.classList.remove('sel'));
  $('btn-import').style.display='inline-flex';
  $('import-status').textContent='';
}

const AVAIL_STATUS_MAP={
  'yes':'Confirmed',
  'no':'Cancelled',
  'maybe':'Needs Coverage',
  'pending':'Needs Coverage',
  '':'Needs Coverage'
};
const AVAIL_NOTE_MAP={
  'yes':'Videographer available',
  'no':'Videographer unavailable',
  'maybe':'Videographer tentative',
  'pending':'Awaiting videographer response',
  '':''
};

async function importParsed(){
  const team=$('p-team').value.trim();
  const rows=$('parse-tbody').querySelectorAll('tr');
  const importedIds=[];
  rows.forEach(row=>{
    const get=f=>row.querySelector('[data-field="'+f+'"]');
    const titleEl=get('title'),dateEl=get('date');
    if(!titleEl||!dateEl)return;
    const title=titleEl.value.trim();
    const date=dateEl.value;
    if(!title||!date)return;
    const avail=row.dataset.avail||'';
    const statusEl=get('status');
    const status=statusEl?statusEl.value:(AVAIL_STATUS_MAP[avail]||'Needs Coverage');
    const notes=AVAIL_NOTE_MAP[avail]||'';
    const colorTag=row.dataset.color||'';
    const typeEl=get('type');
    const type=typeEl?typeEl.value:'Game Coverage';
    const vgEl=get('vg');
    const vg=vgEl?vgEl.value:'Unassigned';
    const jobId=uid();
    importedIds.push(jobId);
    S.jobs.push({
      id:jobId,title,date,
      startTime:get('startTime').value,endTime:get('endTime').value,
      type,team:team,
      assignedVideographer:vg,
      status,
      payAmount:0,notes,colorTag
    });
  });
  for(const j of S.jobs.slice(-importedIds.length)){await saveJob(j);}
  S.lastImportIds=importedIds;
  $('btn-undo').style.display=importedIds.length?'inline-flex':'none';
  $('import-status').textContent='‚úì '+importedIds.length+' jobs imported!';
  $('import-status').style.color='var(--green)';
  $('btn-import').style.display='none';
  setTimeout(()=>{closePasteModal();renderAll();},900);
}

async function undoLastImport(){
  if(!S.lastImportIds.length)return;
  if(!confirm('Undo last import? This will remove '+S.lastImportIds.length+' jobs.'))return;
  for(const id of S.lastImportIds){
    await deleteJobFromDB(id);
    S.jobs=S.jobs.filter(j=>j.id!==id);
  }
  S.lastImportIds=[];
  $('btn-undo').style.display='none';
  renderAll();
}

function navigate(dir){
  const d=S.currentDate;
  if(S.view==='month') d.setMonth(d.getMonth()+dir);
  else if(S.view==='week') d.setDate(d.getDate()+dir*7);
  else d.setMonth(d.getMonth()+dir);
  renderAll();
}

function goToday(){S.currentDate=new Date();renderAll()}

/* ===== INIT ===== */
async function init(){
  // Render immediately so the app is usable
  renderAll();

  // Init Supabase in background
  try{
    if(window.supabase && typeof window.supabase.createClient === 'function'){
      db=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);
      console.log('Supabase client created');
      // Load with 5s timeout
      const timeout=new Promise((_,rej)=>setTimeout(()=>rej(new Error('Supabase load timeout')),5000));
      await Promise.race([loadState(),timeout]);
      console.log('Supabase data loaded:',S.jobs.length,'jobs,',S.videographers.length,'videographers');
      renderAll();
    } else {
      console.warn('Supabase SDK not loaded, running in offline mode');
    }
  }catch(e){console.error('Supabase error (app still works):',e);}


  // View tabs
  document.querySelectorAll('.vtab').forEach(t=>t.addEventListener('click',()=>{
    document.querySelectorAll('.vtab').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');S.view=t.dataset.view;renderNavLabel();renderCalendar();
  }));

  // Navigation
  $('nav-prev').addEventListener('click',()=>navigate(-1));
  $('nav-next').addEventListener('click',()=>navigate(1));
  $('nav-today').addEventListener('click',goToday);

  // Roster toggle
  $('ros-tog').addEventListener('click',()=>{
    const r=$('roster');r.classList.toggle('collapsed');S.rosterOpen=!r.classList.contains('collapsed');
  });

  // Filters
  ['f-status','f-vg','f-team','f-type'].forEach(id=>{
    $(id).addEventListener('change',()=>{
      const map={'f-status':'status','f-vg':'vg','f-team':'team','f-type':'type'};
      S.filters[map[id]]=$(id).value;renderAll();
    });
  });
  $('btn-clr').addEventListener('click',()=>{
    S.filters={status:'',vg:'',team:'',type:''};S.filterVg=null;renderAll();
  });

  // Modal buttons
  $('btn-new').addEventListener('click',()=>openNewModal());
  $('mdl-close').addEventListener('click',closeModal);
  $('mdl-cancel').addEventListener('click',closeModal);
  $('mdl-save').addEventListener('click',saveJobModal);
  $('mdl-del').addEventListener('click',deleteJob);
  $('mo').addEventListener('click',e=>{if(e.target===$('mo'))closeModal()});

  // Multi-VG dropdown toggle
  $('m-vg-display').addEventListener('click',()=>{
    $('m-vg-dd').classList.toggle('open');
  });
  document.addEventListener('click',e=>{
    if(!$('m-vg-wrap').contains(e.target)) $('m-vg-dd').classList.remove('open');
  });

  // Assign mode exit
  $('assign-exit').addEventListener('click',exitAssignMode);

  // VG Modal
  $('btn-addvg').addEventListener('click',openVgModal);
  $('vm-cancel').addEventListener('click',closeVgModal);
  $('vm-save').addEventListener('click',saveVg);
  $('vmo').addEventListener('click',e=>{if(e.target===$('vmo'))closeVgModal()});

  // Day panel
  $('dp-close').addEventListener('click',closeDayPanel);

  // Export
  $('btn-exp').addEventListener('click',exportCSV);
  $('btn-undo').addEventListener('click',undoLastImport);

  // Mass controls init
  initMassControls();

  // Notifications
  $('notif-btn').addEventListener('click',openNotifPanel);
  $('notif-close').addEventListener('click',closeNotifPanel);
  $('notif-clear').addEventListener('click',async()=>{await clearAllNotifications();S.notifications=[];renderNotifBadge();renderNotifPanel();});
  renderNotifBadge();

  // Paste Schedule
  $('btn-paste').addEventListener('click',openPasteModal);
  $('pmo-close').addEventListener('click',closePasteModal);
  $('pmo-cancel').addEventListener('click',closePasteModal);
  $('pmo').addEventListener('click',e=>{if(e.target===$('pmo'))closePasteModal()});
  $('btn-parse').addEventListener('click',parseSchedule);
  $('btn-import').addEventListener('click',importParsed);

  // Keyboard shortcuts
  document.addEventListener('keydown',e=>{
    if(e.target.tagName==='INPUT'||e.target.tagName==='TEXTAREA'||e.target.tagName==='SELECT')return;
    if(e.key==='n'||e.key==='N') openNewModal();
    if(e.key==='Escape'){closeModal();closeVgModal();closeDayPanel()}
  });
}

document.addEventListener('DOMContentLoaded',init);
</script>
</body>
</html>
